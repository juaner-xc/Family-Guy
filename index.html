// ==========================================
// 1. 配置：这里的 IP 必须是你阿里云的公网 IP
// ==========================================
const API_BASE = "http://8.222.254.248:5000/api";

// 获取 DOM 元素
const loginBtn = document.getElementById('loginBtn');
const msg = document.getElementById('msg');
const bookList = document.getElementById('bookList');

/**
 * 登录逻辑
 */
async function doLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    
    msg.innerText = "正在验证...";
    msg.style.color = "#666";

    try {
        const res = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: u, password: p })
        });

        const result = await res.json();
        
        if (result.code === 0) {
            msg.innerText = "登录成功！欢迎 " + (result.data.RealName || "");
            msg.style.color = "green";
            // 登录成功后自动加载书籍
            loadBooks();
        } else {
            msg.innerText = "错误：" + result.msg;
            msg.style.color = "red";
        }
    } catch (e) {
        msg.innerHTML = `<span class="error-text">连接失败！</span><br>
                         <small>请确保后端 python app.py 已启动<br>
                         且阿里云防火墙已开放 5000 端口</small>`;
        console.error("Fetch Error:", e);
    }
}

/**
 * 加载书籍列表
 */
async function loadBooks() {
    try {
        const res = await fetch(`${API_BASE}/books`);
        const result = await res.json();

        if (result.code === 0) {
            bookList.innerHTML = ''; // 清空列表
            
            if (result.data.length === 0) {
                bookList.innerHTML = '<p style="text-align:center; width:100%">暂无可购书籍</p>';
                return;
            }

            result.data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'book-item';
                // 这里的字段名必须与 SQL 视图 [学生视图_可购书籍] 中的字段一致
                li.innerHTML = `
                    <h3 style="margin-top:0">${item.书名}</h3>
                    <p>作者：${item.作者}</p>
                    <p class="price">¥${item.售价}</p>
                    <div style="font-size:12px; color:#888;">
                        <p>卖家：${item.卖家}</p>
                        <p>学院：${item.卖家学院}</p>
                    </div>
                    <button style="margin-top:10px; background:#28a745">立即购买</button>
                `;
                bookList.appendChild(li);
            });
        }
    } catch (e) {
        console.error("加载书籍失败:", e);
    }
}

// 绑定登录按钮点击事件
loginBtn.addEventListener('click', doLogin);

// 页面加载时也可以先尝试加载一下（可选）
// window.onload = loadBooks;

